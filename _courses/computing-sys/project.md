---
title: "课程大作业:满足约束的样例生成器"
layout: course
collection: courses
parent: computing-sys
position: 1
permalink: /courses/computing-sys/project/
---

假设我们用Verilog写好了一个复杂的组合逻辑模块，现在需要写一些测试用例验证其功能。该怎么办呢，手写吗？还是纯随机生成？一般来说模块的合法输入并非是毫无关联的，随机生成的输入很可能现实中根本不会出现。所以，我们面临的问题是：已知一个模块的输入之间有一些关系，现在要尽可能均匀地生成一些测试用例，覆盖到合法输入空间的每一个角落。


你的程序将接收一个json格式的约束，里面会告诉你有几个变量，以及变量之间必须满足的关系；你的程序需要给出一个json格式的输出，包含若干组解，每一组解指明了每个变量的值。详细说明见：[大作业](https://github.com/pku-liang/sv-sampler-lab)

如果你的目标是拿80分，这个大作业主要是工程难度，一点框架都没有，涉及的第三方库也不少(老师后来可能也觉得有这个问题，就在服务器上帮同学们找好了)需要你从零写起。如果你的目标是拿100分，就需要动一些算法的心思了。dz本人显然是前一种类型的同学，先写出来个能跑的拿到大部分分，剩下的优化能做多少就看时间紧迫程度了。

很明显最生成解的部分是核心，必然要用到某种数据结构，而这又是一个数字电路问题，每个变量的每一位只有0和1两种选择，最后结合课上讲的内容，使用BDD建模是很自然的。BDD必然有一个根，我们的要求是使得一些表达式都为真，不难看出可以人为构造一个变量，它的值是所有表达式相与，把这个变量作为根节点构建BDD。我们要在BDD上从根结点找一条路径到达“真”结点，自上而下的一条路径就是找出的一个解。

问题转化为：如何把一些表达式转化成BDD呢？表达式涉及了很多运算，比如移位，蕴含，算术运算等，你当然可以给每个运算指定一个构建BDD的策略，但这个策略有时候并不显然(比如，对两个各$2bit$的操作数$a$和$b$,表达式 $ \& (a << b) $ 的BDD是什么？好像不那么显然),我们需要一个中间表示，将所有表达式转换为这个中间表示，再把中间表示转化为BDD。

一个自然的选择是AIG(And Inverter Graph),那一堆表达式就是verilog代码嘛，我写一个模块，接收所有输入，输出单bit信号为所有表达式结果相与，再用综合工具把它变成AIG,最后根据AIG构造BDD，所有任务就完成了。

以下是大作业实现全流程。

## 第一部分：读入json文件转换为verilog代码

大多数运算都有直接的运算符实现，需要注意的有两个：

- 除法要保证分母不为0
- 蕴含(IMPLY)没有现成的运算符，需要自己写

## 第二部分：调用yosys综合


这一步很简单，详见yosys[官方仓库](https://github.com/YosysHQ/yosys),注意yosys综合时可以做一些优化，减少不必要的中间变量，别忘了这一步。

## 第三部分：构建BDD

使用CUDD库，别忘了把它链接进你自己的工程，使用方法见[CUDD](https://github.com/The-OpenROAD-Project/cudd)。

这部分是运行速度的瓶颈，关键在于构建BDD的策略。


## 在BDD上采样

---


